"use strict";(()=>{var m="prompt_pilot",Ct=`/${m}/v1`;var ee=class{constructor(t){this.model=t}},M=class extends ee{constructor(n,r){super(n);this.matchedWords=[];this.isPriority=r}compare(n,r,o,i,l){if(this.isPriority&&!n.isPriority)return-1;if(!this.isPriority&&n.isPriority)return 1;if(this.model.value===r||o&&this.model.value===o)return-1;if(n.model.value===r||o&&n.model.value===o)return 1;if(n.matchedWords.length!==this.matchedWords.length)return n.matchedWords.length-this.matchedWords.length;if(i.length===this.matchedWords.length){for(let u=0;u<this.matchedWords.length;u++)if(this.matchedWords[u].index!==n.matchedWords[u].index)return this.matchedWords[u].index-n.matchedWords[u].index}if(n.model.useCount!==this.model.useCount)return n.model.useCount-this.model.useCount;let a=l[this.model.value]-l[n.model.value];return a!==0?a:n.model.postCount!==this.model.postCount?n.model.postCount-this.model.postCount:this.model.value<n.model.value?-1:1}},N=class extends ee{constructor(n){super(n);this.matchWords=[];this.startsWith=!1}compare(n,r,o){if(this.model.value===r)return-1;if(n.model.value===r)return 1;if(n.matchWords.length!==this.matchWords.length)return n.matchWords.length-this.matchWords.length;let i=this.matchStarts(o),l=n.matchStarts(o);return i&&!l?-1:!i&&l?1:this.model.value<n.model.value?-1:1}matchStarts(n){for(let r of n)for(let o of this.model.value.split(/[ _-]/g))if(o.startsWith(r))return!0;return!1}},q=class extends ee{constructor(t){super(t)}};var ge=!1,de;function Lt(){return de}function Et(){return ge}function At(e){ge=e}function ke(e){if(!e){ge=!0;return}try{de=[],Object.entries(e.loraModels).forEach(([t,n])=>{de.push({value:t,group:"lora",searchWords:n.search_words,previewFile:n.preview_file})})}catch(t){console.error(t),ge=!0}}function Mt(e){let t=e.toLowerCase().split(/[ _-]/g).filter(o=>o.trim()!==""),n=[];de.forEach(o=>{let i=new Set;for(let l of o.searchWords){let a=l.replace(/[ _-]/g,"");t.forEach(u=>{a.includes(u)&&i.add(u)})}if(t.length===i.size){let l=new N(o);l.matchWords=[...i],n.push(l)}}),n=n.sort((o,i)=>o.compare(i,e,t));let r=window.opts[`${m}_max_results_grouplora`];return n.filter(()=>r>0?(r-=1,!0):!1)}var ve=!1,me;function Pt(){return me}function Wt(){return ve}function zt(e){ve=e}function Dt(e){if(!e){ve=!0;return}try{me={},Object.entries(e.suggestionModels).forEach(([t,n])=>{let r=Object.entries(n).sort(([,o],[,i])=>i-o);me[t]=r.map(([o,i])=>({value:o,count:i}))})}catch(t){console.error(t),ve=!0}}function Nt(e,t){if(!e)return[];let n=me[e];if(!n)return[];let r=[];for(let o of n)t.has(o.value)||r.push(new q(o));return r}var xe=!1,C,I,te,ne;function $t(){return C&&I}function Ft(){return xe}function Ot(e){xe=e}function Ut(e){if(!e){xe=!0;return}try{te=new Set,window.opts[`${m}_always_underscore_tags`].split(/[\n,]/).forEach(t=>{t=t.trim().replace(/_/g," "),t&&te.add(t)}),ne=new Set,window.opts[`${m}_always_space_tags`].split(/[\n,]/).forEach(t=>{t=t.trim().replace(/_/g," "),t&&ne.add(t)}),C={},Object.entries(e.tagModels).forEach(([t,n])=>{let r=t.split(/[ _-]/g),o=C[t]??{value:t,values:t.split(/[ _-]/g),flatValue:r.join(""),category:n.category,useCount:n.use_count,postCount:n.post_count,consequentTagModel:void 0,isOfficial:!0};o.isOfficial=!0;for(let i of n.aliases){let l=i.split(/[ _-]/g),a=C[i]??{value:i,values:i.split(/[ _-]/g),flatValue:l.join(""),category:n.category,useCount:n.use_count,postCount:n.post_count,consequentTagModel:o,isOfficial:!1};a.isOfficial?a.consequentTagModel=o:C[i]=a}C[t]=o}),jn(C)}catch(t){console.error(t),xe=!0}}function Ht(e,t=3){let n=new Set;for(let r of e.split(/[ _-]/g)){let o=Math.min(t,r.length);for(let i=1;i<=o;i++)n.add(r.substring(0,i))}return n}function jn(e){I={};for(let t of Object.values(e)){let n=Ht(t.value,3);for(let r of n)r in I||(I[r]={}),I[r][t.value]=t}}function Gn(e){if(e.value&&e.value in C)return;C[e.value]=e;let t=Ht(e.value,3);for(let n of t)n in I||(I[n]={}),I[n][e.value]=e}function Bt(e){return C[e]}function kt(e,t){let n=e.toLowerCase().split(/[ _-]/g).filter(s=>s.trim()!==""),r;n.length>1&&(r=n.join(""));let o=new Set(t),i=[],l={};n.forEach(s=>{let c=s.length>3?s.slice(0,3):s,g=I[c];for(let x in g){if(x in l)continue;let d=g[x],S=[];if(r&&d.value.startsWith(r))for(let v=0;v<n.length;v++)S.push({word:n[v],index:v});else{let v={};for(let z of n){if(!(0 in v)&&d.flatValue.startsWith(z)){S.push({word:z,index:0}),v[0]=!0;continue}for(let y=0;y<d.values.length;y++)if(!(y in v)&&d.values[y].startsWith(z)){S.push({word:z,index:y}),v[y]=!0;break}}}if(S.length>0){let v=new M(d,o.has(d.value));v.matchedWords=S,i.push(v),l[x]=!0}}});let a=i.filter(s=>!s.model.consequentTagModel).reduce((s,c)=>(s[c.model.value]=c.matchedWords.length,s),{});i=i.filter(s=>{if(!s.model.consequentTagModel)return!0;let c=s.model.consequentTagModel.value;return!(c in a)||a[c]<s.matchedWords.length});let u={},p={};i.forEach(s=>{s.matchedWords.forEach(c=>{u[c.word]||(u[c.word]=0),u[c.word]+=1})}),i.forEach(s=>{p[s.model.value]=s.matchedWords.reduce((c,g)=>c+u[g.word],0)}),i=i.sort((s,c)=>s.compare(c,e,r,n,p));let f={};for(let s of["0","1","3","4","5","custom"])f[s]=window.opts[`${m}_max_results_group${s}`];return i.filter(s=>f[s.model.category]===-1||f[s.model.category]>0?(f[s.model.category]-=1,!0):!1)}function qt(e,t){let r="https://danbooru.donmai.us/autocomplete.json";r+=`?search[query]=${encodeURIComponent(e)}`,r+="&search[type]=tag",r+="&limit=50",r+="&version=1";let o=[];fetch(r).then(async i=>{i.ok&&(o=(await i.json()).map(a=>{let u,p;a.antecedent?(u=a.antecedent,p=C[a.label]):u=a.label;let f=u.split(/[ _-]/g);return new M({value:u,values:f,flatValue:f.join(""),category:a.category.toString(),useCount:0,postCount:a.post_count,consequentTagModel:p,isOfficial:p===void 0},!1)}),o.forEach(a=>{Gn(a.model)})),t(o)}).catch(i=>{console.error("Error fetching tag data:",i),t(o)})}var Vt,Kt,jt=!0,re=[],Gt,ye=[],Zt,Xt,Yt,Jt;function V(){return Vt}function Qt(e){Vt=e}function _(){return Kt}function en(e){Kt=e}function $(){return jt}function Ve(e){jt=e}function Ke(){return re}function tn(e){return re[e]}function F(){return re.length>0}function Se(){re=[]}function Te(e){re.push(e)}function A(){return Gt}function P(e){Gt=e}function K(){return ye}function nn(e){return ye[e]}function oe(e){ye=e}function je(){ye=[]}function we(){return Zt}function rn(e){Zt=e}function be(){return Xt}function on(e){Xt=e}function Ge(){return Yt}function sn(e){Yt=e}function Ze(){return Jt}function Re(e){Jt=e}function Xe(e,t){let n=null,r=null,o=null,i=!1;return(...l)=>{let a=Date.now();!r||a-r>=t?(e(...l),i=!1):(i=!0,o=l),r=a,n&&clearTimeout(n),n=setTimeout(()=>{i&&o&&e(...o),r=null,i=!1},t)}}async function an(e,t,n=5,r=1e3){for(let o=0;o<=n;o++){let i=await fetch(e,t);if(i.ok)return i;if(o===n)return console.error(`[Prompt Pilot] Fetch failed after ${n} attempts`),i;console.warn(`[Prompt Pilot] Retrying... (${o+1}/${n})`),await new Promise(l=>setTimeout(l,r))}throw new Error("Unexpected error in fetchWithRetry")}function ln(e){return Math.abs(e)>=1e12?(e/1e12).toFixed(1)+"T":Math.abs(e)>=1e9?(e/1e9).toFixed(1)+"G":Math.abs(e)>=1e6?(e/1e6).toFixed(1)+"M":Math.abs(e)>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function ie(e){return e.replace(/[.*+?^${}()|\[\]\\]/g,"\\$&")}function Ye(e){return e.replace(/[{}()\[\]\\]/g,"\\$&")}function un(e){let t="";for(let n=0;n<e.length;n++)e[n]==="\\"?n+1<e.length?(t+=e[n+1],n++):t+="\\":t+=e[n];return t}function cn(e,t){let n=[],r=t,o,i=0;for(;(o=r.exec(e))!==null;)n.push({word:e.slice(i,o.index),position:i}),i=r.lastIndex;return n.push({word:e.slice(i),position:i}),n}var fn,pn,hn=!1,gn=!1,Je,Le,se,Qe,et,tt;function dn(e,t){fn=e,pn=t,Je="",Le=-1,se=[],Qe=!1,et=!1,tt=!1}function nt(){return fn}function ae(){return pn}function le(){return hn}function Ee(e){hn=e}function vn(){return gn}function rt(e){gn=e}function U(){return Je}function ot(e){Je=e}function ue(){return Le}function mn(e){Le=e}function j(){return se}function xn(e){return se[e]}function O(){return se[Le]}function yn(e){se.push(e)}function Sn(){return Qe}function G(e){Qe=e}function it(){return et}function Tn(e){et=e}function st(){return tt}function Ae(e){tt=e}function Ie(e){if(e||(e=A()),!e)return;let t;if(e instanceof M)t=Zn(e.model);else if(e instanceof N)t=Xn(e.model);else if(e instanceof q)t=Yn(e.model);else return;let n=window.opts[`${m}_using_execCommand`],r=_();if(n)r.focus(),r.setSelectionRange(t.range.start,t.range.end),document.execCommand("insertText",!1,t.insertText);else{let o=r.value;r.value=o.slice(0,t.range.start)+t.insertText+o.slice(t.range.end)}r.selectionStart=r.selectionEnd=t.range.start+t.insertText.length}function Zn(e){let t=O().position,n=-1,r=[];r.push(e.value),e.consequentTagModel&&r.push(e.consequentTagModel.value);let o=nt().substring(t,ae());for(let p of cn(o,/[ _-]/g))for(let f of r){if(p.word==="")continue;let s=ie(un(p.word)),c=new RegExp(`(?:^|[ _-])${s}`,"gi").exec(f);c&&c.index!==-1&&(n===-1||n>p.position)&&(n=p.position)}n>-1&&(t+=n);let i=e.isOfficial?e.value:e.consequentTagModel.value,l=window.opts[`${m}_tag_source`].replace(/\./g,"_"),a=window.opts[`${m}_${l}_${e.category}_tag_delimiter`]??"auto";if(!ne.has(i)){let p=!1;te.has(i)||a==="underscore"?p=!0:a==="auto"&&(p=U().includes("_")),p&&(i=i.replace(/ /g,"_"))}return it()?i=", "+i:n<=0&&st()&&(i=" "+i),i=Ye(i),window.opts[`${m}_append_comma`]&&(i+=","),i+=" ",{range:{start:t,end:ae()},insertText:i}}function Xn(e){let t=O().position,n=e.value,r=nt().substring(t).match(/^<(?:lora|lyco):[^<>:]+(:.+>)/i),o=ae();return r?(o=t+r[0].length,n+=r[1]):n+=":1>",n+=" ",{range:{start:t,end:o},insertText:n}}function Yn(e){let t=O().position,r=Bt(e.value)?.category??"custom",o=Ye(e.value),i=window.opts[`${m}_tag_source`].replace(/\./g,"_"),l=window.opts[`${m}_${i}_${r}_tag_delimiter`]??"auto";if(!ne.has(o)){let u=!1;te.has(o)||l==="underscore"?u=!0:l==="auto"&&(u=U().includes("_")),u&&(o=o.replace(/ /g,"_"))}return it()?o=", "+o:st()&&(o=" "+o),window.opts[`${m}_append_comma`]&&(o+=","),o+=" ",{range:{start:t,end:ae()},insertText:o}}var bn={"(":1,"[":2,"{":3,"<":4},Jn={")":1,"]":2,"}":3,">":4},Qn={0:"",1:")",2:"]",3:"}",4:">",5:">"},er={0:new Set([","]),1:new Set([","]),2:new Set([",",":","|"]),3:new Set([",","|"]),4:new Set([",","|"]),5:new Set},tr=new Set([",","|",":","(","[","{","<"]),Pe=5,nr=["BREAK","AND","ADDCOMM","ADDBASE","ADDCOL","ADDROW"],rr=/\{([\d-]+\$\$(?:[^\}]+?\$\$)?)(.*)\}/g,or=new RegExp(`\\b(${nr.join("|")})\\b`,"g");function Z(e,t){let n=e===5?1:0;return{value:"",position:t,type:n,isActive:!1}}function We(e,t){dn(e,t),e=e.replace(or,s=>",".padEnd(s.length,"\0")),e=e.replace(rr,(s,c,g)=>`{${"\0".repeat(c.length)}${g}}`);let n=[0],r=!1,o,i=!0;function l(s){s.value=s.value.trim(),(s.isActive||s.value!=="")&&(yn(s),i=!1,o=void 0)}function a(s){s===`
`?i=!0:tr.has(s)&&(o=s)}function u(s){s.isActive&&j().length>0&&(o===void 0?(Tn(!0),i||Ae(!0)):o===","&&Ae(!0))}function p(s){s.isActive=!0;let c=U();r&&(c+="\\",ot(c)),ot(s.value.trim()),mn(j().length)}let f=Z(0,0);for(let s=0;s<e.length;s++){let c=e[s];s===t&&p(f);let g=n[n.length-1];if(c==="\0"){f.isActive&&(G(!0),Ae(!0)),f.position++;continue}if(c===`
`){u(f),l(f),a(c),f=Z(g,s+1),r=!1;continue}if(r){f.value+=c,r=!1;continue}if(c==="\\"){r=!0;continue}if(c in bn){let x=bn[c];if(x===4&&e.length-s>Pe){let d=e.substring(s+1,s+Pe+1);(d==="lora:"||d==="lyco:")&&(x=5)}n.push(x),x===5&&(s+=Pe,s-t>=0&&s-t<Pe&&G(!0)),u(f),l(f),a(c),x===5?f=Z(x,s+1):f=Z(x,s);continue}if(c in Jn){let x=Qn[g];if(c!==x){f.value+=c;continue}if(g===1||g===2){let d=f.value.lastIndexOf(":");if(d>=0){let S=f.value.substring(0,d),v=f.value.substring(d+1);Rn(v)&&(f.value=S,f.isActive&&s-t<=v.length&&G(!0))}else g===2&&Rn(f.value)&&(f.isActive&&s-t<=f.value.length&&G(!0),f.value="")}else if(g===5){let d=f.value.indexOf(":");if(d>=0){let S=f.value.substring(0,d),v=f.value.substring(d+1);f.isActive&&s-t<=v.length&&G(!0),f.value=S}}n.pop(),u(f),l(f),a(c),f=Z(n[n.length-1],s+1);continue}if(g===5){(f.value!==""||c!==" ")&&(f.value+=c);continue}if(er[g]?.has(c)){u(f),l(f),a(c),f=Z(g,s+1);continue}f.value===""&&(f.position=s),f.value+=c}ue()<0&&p(f),j().forEach(s=>{s.value=s.value.replace(/_/g," ")}),u(f),l(f)}function Rn(e){return e.trim()===""?!1:!isNaN(+e)}var T,ir=200,sr=Xe(lr,ir),ar=Xe(qt,1100);function An(e){Qt(document.createElement("div"));let t=V();t.id="suggestion-box",w(t,!1),t.style.top="0",t.style.left="0",e.appendChild(t),rn(document.createElement("div"));let n=we();n.className="tab-container",t.appendChild(n);let r=["All","Gen","Art","","Copy","Chara","Meta"];for(let l=0;l<r.length;l++){let a=r[l];if(a==="")continue;let u=document.createElement("div");u.className="tab",l===0&&(u.classList.add("selected"),Re(u));let p=`group${l-1}`;l>0&&(u.dataset.category=p,u.classList.add(p)),u.textContent=a,u.addEventListener("mousedown",f=>{Re(f.target),In(),f.preventDefault()}),n.appendChild(u)}on(document.createElement("ul"));let o=be();t.appendChild(o),sn(document.createElement("div"));let i=Ge();i.className="preview",i.appendChild(document.createElement("img")),t.appendChild(i),o.addEventListener("mousedown",l=>{if(!F())return;let a=A();if(a&&(l.target instanceof HTMLLIElement||l.target instanceof HTMLAnchorElement)&&(l.stopPropagation(),Ie(a),l.target instanceof HTMLAnchorElement)){let u=a.model,p=u.isOfficial?u.value:u.consequentTagModel.value;De(p)}}),o.addEventListener("mousemove",l=>{if(!F())return;let a=l.target.closest("li");a&&fr(nn(+a.dataset.index))}),T=document.createElement("li"),T.className="notice"}function Mn(e){window.pilotIsActive&&en(e)}function X(){if(!window.pilotIsActive)return;let e=_();if(!e)return;let t=e.dummy,n=t.caret,r=e.selectionEnd,o=e.value.slice(0,r),i=e.value.slice(r);t.textContent=o,n.textContent=i[0]||"\u200B",t.appendChild(n);let l=n.getBoundingClientRect(),a=window.getComputedStyle(e),u=parseFloat(a.lineHeight.replace(/[^\d\.]+/,"")),p=e.getBoundingClientRect(),f=l.left-p.left-e.scrollLeft,s=l.top-p.top-e.scrollTop+u,c=V();c.style.transform=`translate(${f}px, ${s}px)`,sr()}function lr(){if(!window.pilotIsActive||le())return;if(Ft()||Et()||Wt()){H(at(),1,"An error occurred. Please reload the page.");return}if(!$t()||!Lt()||!Pt()){H(at(),1,"Initializing database...");return}let e=_();if(We(e.value,e.selectionEnd),Sn()){ze();return}let t=new Set(j().filter((i,l)=>l!==ue()&&i.type!==1).map(i=>i.value)),n=O(),r=U();if(n.type===1&&r===""){ze();return}if(!window.opts[`${m}_suggest_enabled`]&&r===""){ze();return}let o=[];if(n.type!==1){let i;for(let a=ue()-1;a>=0;a--){let u=xn(a);if(u.type!==1){i=u.value;break}}let l=Nt(i,t);if(r===""){oe(l.slice(0,10)),H(ur(),2);return}for(let a of l)a.model.value.startsWith(r)&&o.push(a.model.value);if(r.startsWith("*")&&r.length>1)ar(r.substring(1),a=>{oe(a),H(En(t),0)}),je(),H(null,0,"Waiting for API response...");else{let a=kt(r,o);oe(a),H(En(t),0)}}else oe(Mt(r)),H(at(),1)}function En(e){let t=document.createDocumentFragment();return K().forEach(n=>{let r=document.createElement("li"),o=document.createElement("span");o.className="highlight";let i=document.createElement("a");i.className="wiki";let l=document.createElement("span");l.className="title";let a=document.createElement("span");a.className="post-count";let u=n.model.value,p=u;for(let f of n.matchedWords){let s=ie(f.word);p=p.replace(new RegExp(`(?<=^| |-|>)(${s})(?!>)`,"gi"),"<b>$1</b>")}n.model.consequentTagModel&&(u=n.model.consequentTagModel.value,p+="<span></span>"+u),l.innerHTML=p,n.model.useCount>0&&o.classList.add("recommend"),n.model.postCount>0&&(i.textContent="?",a.textContent=ln(n.model.postCount)),e.has(u)&&r.classList.add("contains"),r.classList.add(`group${n.model.category}`),r.appendChild(o),r.appendChild(i),r.appendChild(l),r.appendChild(a),t.appendChild(r)}),t}function at(){let e=document.createDocumentFragment();return K().forEach(t=>{let n=document.createElement("li"),r=document.createElement("span");r.className="title";let o=t.model.value;for(let i of t.matchWords){let l=ie(i);o=o.replace(new RegExp(`(${l})(?!>)`,"gi"),"<b>$1</b>")}r.innerHTML=`&lt;lora:${o}&gt;`,n.classList.add(`group${t.model.group}`),n.appendChild(r),e.appendChild(n)}),e}function ur(){let e=document.createDocumentFragment();return K().forEach(t=>{let n=document.createElement("li");n.textContent=t.model.value,n.classList.add("suggest"),e.appendChild(n)}),e}function cr(){let e=_().getBoundingClientRect(),t=V();t.style.top=`${e.top+window.scrollY}px`,t.style.left=`${e.left+window.scrollX}px`}function H(e,t,n=void 0){cr(),Se();let r=be();if(r.scrollTop=0,r.innerHTML="",t!==2&&r.appendChild(T),e?.children?.length){let l=K();for(let a=0;a<e.children.length;a++){let u=e.children[a];l[a].view=u,u.dataset.index=a.toString(),a===0&&u.classList.add("selected"),u.dataset.navigateIndex=a.toString(),Te(l[a])}r.appendChild(e)}r.scrollTop=0,T.dataset.type="",w(T,!1),n?(T.textContent=n,T.dataset.type="pending",w(T,!0)):t!==2&&!F()&&(T.textContent="Not found",w(T,!0));let o=we();t===0?(o.classList.remove("no-tab"),Re(o.children[0]),In()):o.classList.contains("no-tab")||o.classList.add("no-tab");let i=Ke();i.length>0?P(i[0]):P(void 0),lt(),Ve(!1),w(V(),!0)}function lt(){let e=A(),t=Ge();e instanceof N?(t.children[0].setAttribute("src",e.model.previewFile),w(t,!0)):(t.children[0].removeAttribute("src"),w(t,!1))}function ut(e){if(!F())return;let t=A();t?t.view.classList.remove("selected"):(t=tn(0),P(t));let n=t.view;if(t){let r=parseInt(n.dataset.navigateIndex??"0")+e,o=Ke();r<0?P(o[o.length-1]||null):r>=o.length?P(o[0]||null):P(o[r])}n=A().view,n&&(n.classList.add("selected"),n.scrollIntoView({block:"nearest"})),lt()}function fr(e){let t=A();e!==t&&(t&&t.view.classList.remove("selected"),P(e),e.view.classList.add("selected"),lt())}function In(){let e=we();for(let o of Array.from(e.children))o===Ze()?o.classList.contains("selected")||o.classList.add("selected"):o.classList.remove("selected");let t=be();t.scrollTop=0,Se();let n=Ze().dataset.category,r=0;K().forEach(o=>{let i=o.view;i.classList.contains("notice")||(n?i.classList.contains(n)?(i.dataset.navigateIndex=r.toString(),Te(o),w(i,!0),r++):(i.dataset.navigateIndex="-1",w(i,!1)):(i.dataset.navigateIndex=r.toString(),Te(o),w(i,!0),r++))}),w(T,!1),T.dataset.type==="pending"?w(T,!0):F()||(T.textContent="Not found",w(T,!0)),ut(0)}function w(e,t){e.style.display=t?"":"none"}function ze(){w(V(),!1),je(),Se(),P(void 0)}function ce(){$()||(Ve(!0),ze())}function De(e){if(e){e=e.replace(" ","_"),/^[0-9]+$/.test(e)&&(e=`~${e}`);let t=window.opts[`${m}_tag_source`];window.open(`https://${t}/wiki_pages/${encodeURIComponent(e)}`)}}var Wn=!1,ct;function zn(e){if(!Wn){Wn=!0;let r=getComputedStyle(e),o="",i=new Set(["width","height","inline-size","block-size","resize"]);for(let a=0;a<r.length;a++){let u=r[a];if(!i.has(u)){let p=r.getPropertyValue(u);o+=`${u}: ${p};`}}let l=new CSSStyleSheet;l.replaceSync(`.prompt_pilot-dummy {${o}}`),document.adoptedStyleSheets=[...document.adoptedStyleSheets,l]}let t=document.createElement("div");t.className="prompt_pilot-dummy",t.style.position="absolute",t.style.visibility="hidden",t.style.pointerEvents="none",e.parentNode?.insertBefore(t,e.nextSibling),e.dummy=t;let n=document.createElement("span");t.caret=n,e.addEventListener("focus",r=>pr(r)),e.addEventListener("blur",()=>hr()),e.addEventListener("compositionend",()=>vr()),e.addEventListener("input",()=>mr()),e.addEventListener("keydown",r=>xr(r)),e.addEventListener("keyup",r=>yr(r)),e.addEventListener("mousedown",r=>gr(r)),e.addEventListener("mouseup",r=>dr(r))}function pr(e){Mn(e.target)}function hr(){ce()}function gr(e){window.pilotIsActive&&(ce(),e.ctrlKey&&setTimeout(()=>{ct=new Promise(t=>{let n=_();We(n.value,n.selectionEnd),t(O())})},50))}function dr(e){window.pilotIsActive&&e.ctrlKey&&ct&&ct.then(t=>{t.type!==1&&De(t.value)})}function vr(){Ee(!1),X()}function mr(){vn()?$()||ce():X()}function xr(e){if(!window.pilotIsActive)return;let t=e.key;if(e.ctrlKey&&(t==="ArrowDown"||t==="ArrowUp")&&rt(!0),Ee(e.isComposing),!le()&&!$()){if(t==="Escape"){ce(),e.preventDefault(),e.stopPropagation();return}if(F())if(t==="Tab"){let n=A();if(n&&(Ie(n),e.shiftKey&&n instanceof M&&n.model.isOfficial!==void 0)){let r=n.model.isOfficial?n.model.value:n.model.consequentTagModel.value;De(r)}e.preventDefault()}else(t==="ArrowDown"||t==="ArrowUp")&&!e.ctrlKey&&!e.shiftKey&&(ut(t==="ArrowDown"?1:-1),e.preventDefault())}}function yr(e){if(!window.pilotIsActive||(rt(!1),Ee(e.isComposing),le())||$())return;let t=e.key;["ArrowLeft","ArrowRight","Home","End"].includes(t)&&(X(),e.preventDefault())}var b=Uint8Array,Y=Uint16Array,Tr=Int32Array,Dn=new b([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Nn=new b([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),wr=new b([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_n=function(e,t){for(var n=new Y(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];for(var o=new Tr(n[30]),r=1;r<30;++r)for(var i=n[r];i<n[r+1];++i)o[i]=i-n[r]<<5|r;return{b:n,r:o}},$n=_n(Dn,2),Fn=$n.b,br=$n.r;Fn[28]=258,br[258]=28;var On=_n(Nn,0),Rr=On.b,ho=On.r,ht=new Y(32768);for(h=0;h<32768;++h)W=(h&43690)>>1|(h&21845)<<1,W=(W&52428)>>2|(W&13107)<<2,W=(W&61680)>>4|(W&3855)<<4,ht[h]=((W&65280)>>8|(W&255)<<8)>>1;var W,h,fe=function(e,t,n){for(var r=e.length,o=0,i=new Y(t);o<r;++o)e[o]&&++i[e[o]-1];var l=new Y(t);for(o=1;o<t;++o)l[o]=l[o-1]+i[o-1]<<1;var a;if(n){a=new Y(1<<t);var u=15-t;for(o=0;o<r;++o)if(e[o])for(var p=o<<4|e[o],f=t-e[o],s=l[e[o]-1]++<<f,c=s|(1<<f)-1;s<=c;++s)a[ht[s]>>u]=p}else for(a=new Y(r),o=0;o<r;++o)e[o]&&(a[o]=ht[l[e[o]-1]++]>>15-e[o]);return a},pe=new b(288);for(h=0;h<144;++h)pe[h]=8;var h;for(h=144;h<256;++h)pe[h]=9;var h;for(h=256;h<280;++h)pe[h]=7;var h;for(h=280;h<288;++h)pe[h]=8;var h,Un=new b(32);for(h=0;h<32;++h)Un[h]=5;var h;var Cr=fe(pe,9,1);var Lr=fe(Un,5,1),ft=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},L=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(t&7)&n},pt=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(t&7)},Er=function(e){return(e+7)/8|0},Ar=function(e,t,n){return(t==null||t<0)&&(t=0),(n==null||n>e.length)&&(n=e.length),new b(e.subarray(t,n))};var Mr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],E=function(e,t,n){var r=new Error(t||Mr[e]);if(r.code=e,Error.captureStackTrace&&Error.captureStackTrace(r,E),!n)throw r;return r},Ir=function(e,t,n,r){var o=e.length,i=r?r.length:0;if(!o||t.f&&!t.l)return n||new b(0);var l=!n,a=l||t.i!=2,u=t.i;l&&(n=new b(o*3));var p=function(wt){var bt=n.length;if(wt>bt){var Rt=new b(Math.max(bt*2,wt));Rt.set(n),n=Rt}},f=t.f||0,s=t.p||0,c=t.b||0,g=t.l,x=t.d,d=t.m,S=t.n,v=o*8;do{if(!g){f=L(e,s,1);var z=L(e,s+1,3);if(s+=3,z)if(z==1)g=Cr,x=Lr,d=9,S=5;else if(z==2){var Fe=L(e,s,31)+257,gt=L(e,s+10,15)+4,dt=Fe+L(e,s+5,31)+1;s+=14;for(var J=new b(dt),Oe=new b(19),R=0;R<gt;++R)Oe[wr[R]]=L(e,s+R*3,7);s+=gt*3;for(var vt=ft(Oe),Bn=(1<<vt)-1,kn=fe(Oe,vt,1),R=0;R<dt;){var mt=kn[L(e,s,Bn)];s+=mt&15;var y=mt>>4;if(y<16)J[R++]=y;else{var B=0,he=0;for(y==16?(he=3+L(e,s,3),s+=2,B=J[R-1]):y==17?(he=3+L(e,s,7),s+=3):y==18&&(he=11+L(e,s,127),s+=7);he--;)J[R++]=B}}var xt=J.subarray(0,Fe),D=J.subarray(Fe);d=ft(xt),S=ft(D),g=fe(xt,d,1),x=fe(D,S,1)}else E(1);else{var y=Er(s)+4,_e=e[y-4]|e[y-3]<<8,$e=y+_e;if($e>o){u&&E(0);break}a&&p(c+_e),n.set(e.subarray(y,$e),c),t.b=c+=_e,t.p=s=$e*8,t.f=f;continue}if(s>v){u&&E(0);break}}a&&p(c+131072);for(var qn=(1<<d)-1,Vn=(1<<S)-1,Ue=s;;Ue=s){var B=g[pt(e,s)&qn],k=B>>4;if(s+=B&15,s>v){u&&E(0);break}if(B||E(2),k<256)n[c++]=k;else if(k==256){Ue=s,g=null;break}else{var yt=k-254;if(k>264){var R=k-257,Q=Dn[R];yt=L(e,s,(1<<Q)-1)+Fn[R],s+=Q}var He=x[pt(e,s)&Vn],Be=He>>4;He||E(3),s+=He&15;var D=Rr[Be];if(Be>3){var Q=Nn[Be];D+=pt(e,s)&(1<<Q)-1,s+=Q}if(s>v){u&&E(0);break}a&&p(c+131072);var St=c+yt;if(c<D){var Tt=i-D,Kn=Math.min(D,St);for(Tt+c<0&&E(3);c<Kn;++c)n[c]=r[Tt+c]}for(;c<St;++c)n[c]=n[c-D]}}t.l=g,t.p=Ue,t.b=c,t.f=f,g&&(f=1,t.m=d,t.d=x,t.n=S)}while(!f);return c!=n.length&&l?Ar(n,0,c):n.subarray(0,c)};var Pr=new b(0);var Wr=function(e){(e[0]!=31||e[1]!=139||e[2]!=8)&&E(6,"invalid gzip data");var t=e[3],n=10;t&4&&(n+=(e[10]|e[11]<<8)+2);for(var r=(t>>3&1)+(t>>4&1);r>0;r-=!e[n++]);return n+(t&2)},zr=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0};function Hn(e,t){var n=Wr(e);return n+8>e.length&&E(6,"invalid gzip data"),Ir(e.subarray(n,-8),{i:2},t&&t.out||new b(zr(e)),t&&t.dictionary)}var Dr=typeof TextDecoder<"u"&&new TextDecoder,Nr=0;try{Dr.decode(Pr,{stream:!0}),Nr=1}catch{}window.pilotIsActive=!0;var Ne,_r=new Promise(e=>{Ne=e});onUiLoaded(()=>{try{An(document.body),gradioApp().querySelectorAll("*:is([id*='_toprow'] [id*='_prompt'], .prompt) textarea").forEach(o=>{zn(o)}),gradioApp().querySelectorAll(".extra-network-control--refresh").forEach(o=>{o.addEventListener("click",()=>{fetch(`${Ct}/refresh`,{method:"POST"}).then(async i=>{let l=await i.json();ke(l)})})}),an("file=extensions/sd-webui-prompt-pilot/models.json.gz",{}).then(async o=>{o.ok||(Ot(!0),At(!0),zt(!0));let i=new Uint8Array(await o.arrayBuffer()),l=Hn(i),a=new TextDecoder("utf-8").decode(l),u=JSON.parse(a);_r.then(()=>{Ut(u),ke(u),Dt(u),$()||X()})})}catch(e){console.error(e)}});onOptionsChanged(()=>{window.pilotIsActive=window.opts[`${m}_enabled`],Ne&&(Ne(!0),Ne=null)});})();
//# sourceMappingURL=prompt_pilot.js.map
